<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- Erlaubt die Einbettung des Players von beliebigen Domains -->
    <meta http-equiv="Content-Security-Policy" content="frame-ancestors *;">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>FilmFrei24 Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        :root {
            --primary-bg: #0a0a0a;
            --secondary-bg: #1a1a1a;
            --accent-color: #ff6b35;
            --text-color: #ffffff;
            --text-secondary: #b3b3b3;
            --control-bg: linear-gradient(transparent, rgba(0,0,0,0.9));
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }



        /* Big Play Button overlay */
        .big-play-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 50;
            transition: transform 0.2s ease;
        }

        .big-play-btn:hover {
            transform: translate(-50%, -50%) scale(1.05);
        }

        .big-play-btn svg {
            fill: var(--accent-color);
            width: 36px;
            height: 36px;
        }

        .big-play-btn.hide {
            display: none;
        }

        html, body {
            background: var(--primary-bg);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            touch-action: none;
            -webkit-text-size-adjust: 100%;
        }

        #player {
            width: 100%;
            height: 100%;
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Video Element */
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
            display: block;
            -webkit-playsinline: true;
            playsinline: true;
        }

        /* Hide native controls */
        video::-webkit-media-controls,
        video::-webkit-media-controls-enclosure,
        video::-webkit-media-controls-panel,
        video::-webkit-media-controls-play-button,
        video::-webkit-media-controls-timeline,
        video::-webkit-media-controls-timeline-container,
        video::-webkit-media-controls-mute-button,
        video::-webkit-media-controls-volume-slider,
        video::-webkit-media-controls-fullscreen-button {
            display: none !important;
            -webkit-appearance: none !important;
        }

        /* Loader */
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: block;
            z-index: 15;
        }

        .loader.hide {
            display: none;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Resume Overlay */
        .resume-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }

        .resume-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .resume-box {
            background: var(--secondary-bg);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            max-width: 450px;
            width: 100%;
            border: 1px solid #333;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .resume-title {
            color: var(--text-color);
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .resume-text {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .resume-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .resume-btn {
            padding: 14px 32px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            flex: 1;
            max-width: 180px;
        }

        .resume-btn:hover {
            transform: translateY(-2px);
        }

        .resume-btn:active {
            transform: translateY(0);
        }

        .resume-btn.primary {
            background: var(--accent-color);
            color: white;
            box-shadow: 0 4px 20px rgba(255, 107, 53, 0.3);
        }

        .resume-btn.secondary {
            background: #333;
            color: white;
        }



        /* Controls Container */
        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--control-bg);
            padding: 30px 20px 20px;
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            transform: translateY(100%);
            z-index: 20;
        }

        .controls.show {
            opacity: 1;
            transform: translateY(0);
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Control Buttons */
        .btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: none;
            color: white;
            cursor: pointer;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .btn:hover {
            background: rgba(255, 107, 53, 0.2);
            transform: scale(1.1);
        }

        .btn svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        /* Progress Bar */
        .progress {
            flex: 1;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 0 10px;
            position: relative;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            position: relative;
        }

        .progress-buffer {
            position: absolute;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            width: 0%;
        }

        .progress-fill {
            position: absolute;
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            border-radius: 3px;
            z-index: 2;
            transition: width 0.1s linear;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            right: -10px;
            top: -7px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* Time Display */
        .time {
            color: white;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            min-width: 90px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* Volume Control */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-slider {
            width: 80px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }

        .volume-fill {
            height: 100%;
            background: var(--accent-color);
            border-radius: 3px;
            width: 100%;
            transition: width 0.2s;
        }

        /* Fullscreen Button */
        .fullscreen-btn {
            background: var(--accent-color) !important;
            border: 2px solid white !important;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            .volume-control {
                display: none;
            }
            .btn {
                width: 40px;
                height: 40px;
            }
            .btn svg {
                width: 20px;
                height: 20px;
            }
            .time {
                font-size: 12px;
                min-width: 80px;
                padding: 6px 10px;
            }
            .controls {
                padding: 20px 15px 15px;
                padding-bottom: env(safe-area-inset-bottom, 15px);
            }
            .resume-box {
                padding: 30px 20px;
            }
            .resume-title {
                font-size: 1.5rem;
            }
            .resume-text {
                font-size: 1rem;
            }
            .resume-buttons {
                flex-direction: column;
                gap: 10px;
            }
            .resume-btn {
                max-width: 100%;
                width: 100%;
            }
        }

        /* Click/Tap Area */
        .tap-area {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 5;
        }

        /* Fullscreen Styles - iOS optimiert */
        .fullscreen-active {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 999999 !important;
            background: #000 !important;
        }

        /* iOS spezifische Fullscreen-Styles */
        @supports (-webkit-touch-callout: none) {
            .fullscreen-active video {
                width: 100vw !important;
                height: 100vh !important;
                object-fit: contain !important;
            }
            /* iOS Safari spezifische Korrekturen */
            video::-webkit-media-controls-fullscreen-button {
                display: none !important;
            }
            video:-webkit-full-screen {
                width: 100% !important;
                height: 100% !important;
            }
        }

        /* Webkit Fullscreen */
        :-webkit-full-screen {
            width: 100vw !important;
            height: 100vh !important;
        }

        /* iOS Landscape Fullscreen Fix */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .fullscreen-active .controls {
                padding: 15px 20px 10px;
            }
            .fullscreen-active .btn {
                width: 35px;
                height: 35px;
            }
            .fullscreen-active .btn svg {
                width: 18px;
                height: 18px;
            }
        }
    </style>
</head>
<body>
    <div id="player">
        <!-- Preload nur Metadaten, um das Laden großer Dateien zu beschleunigen. -->
        <!-- Autoplay wurde entfernt: Der Benutzer startet das Video über den Big‑Play‑Button. 
             'muted' kann optional gesetzt werden, aber hier weggelassen, damit der Film mit Ton startet. -->
        <video id="video" playsinline webkit-playsinline x5-playsinline preload="metadata"></video>
        <div class="tap-area" id="tapArea"></div>
        <!-- Der Loader ist initial ausgeblendet. Er wird erst beim Laden des Videos eingeblendet. -->
        <div class="loader hide" id="loader"></div>
        <!-- Grosser Play‑Button in der Mitte, um das Video zu starten -->
        <div class="big-play-btn" id="bigPlayBtn">
            <svg viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z"/>
            </svg>
        </div>
        <div class="resume-overlay" id="resumeOverlay">
            <div class="resume-box">
                <h2 class="resume-title">Video fortsetzen?</h2>
                <p class="resume-text">Möchten Sie das Video an der letzten Stelle fortsetzen?</p>
                <div class="resume-buttons">
                    <button class="resume-btn primary" id="resumeBtn">Fortsetzen</button>
                    <button class="resume-btn secondary" id="restartBtn">Neu starten</button>
                </div>
            </div>
        </div>
        <div class="controls" id="controls">
            <div class="control-row">
                <button class="btn" id="playPause">
                    <svg id="playIcon" viewBox="0 0 24 24" style="display:none">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg id="pauseIcon" viewBox="0 0 24 24">
                        <path d="M6 4h4v16H6zm8 0h4v16h-4z"/>
                    </svg>
                </button>
                <div class="progress" id="progress">
                    <div class="progress-bar">
                        <div class="progress-buffer" id="progressBuffer"></div>
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
                <div class="time" id="time">0:00 / 0:00</div>
                <div class="volume-control">
                    <button class="btn" id="mute">
                        <svg id="volumeIcon" viewBox="0 0 24 24">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
                        </svg>
                        <svg id="muteIcon" viewBox="0 0 24 24" style="display:none">
                            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                        </svg>
                    </button>
                    <div class="volume-slider" id="volumeSlider">
                        <div class="volume-fill" id="volumeFill"></div>
                    </div>
                </div>
                <button class="btn fullscreen-btn" id="fullscreen">
                    <svg id="enterFS" viewBox="0 0 24 24">
                        <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                    </svg>
                    <svg id="exitFS" viewBox="0 0 24 24" style="display:none">
                        <path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <script>
// Diese HTML‑Version des Players liest den Videolink aus der Query‑Zeile aus.
// Beispiel: embed.html?https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4

// Player Elements
const player = document.getElementById('player');
const video = document.getElementById('video');
const tapArea = document.getElementById('tapArea');
const loader = document.getElementById('loader');
const controls = document.getElementById('controls');
const playPause = document.getElementById('playPause');
const playIcon = document.getElementById('playIcon');
const pauseIcon = document.getElementById('pauseIcon');
const progress = document.getElementById('progress');
const progressFill = document.getElementById('progressFill');
const progressBuffer = document.getElementById('progressBuffer');
const time = document.getElementById('time');
const mute = document.getElementById('mute');
const volumeIcon = document.getElementById('volumeIcon');
const muteIcon = document.getElementById('muteIcon');
const volumeSlider = document.getElementById('volumeSlider');
const volumeFill = document.getElementById('volumeFill');
const fullscreenBtn = document.getElementById('fullscreen');
const enterFS = document.getElementById('enterFS');
const exitFS = document.getElementById('exitFS');
// Audio and subtitle selection elements
const resumeOverlay = document.getElementById('resumeOverlay');
const resumeBtn = document.getElementById('resumeBtn');
const restartBtn = document.getElementById('restartBtn');

let controlsTimer;
let isFullscreen = false;
let progressInterval;
let lastTapTime = 0;
let isDragging = false;
let hasAutoResumed = false;

// Device Detection
const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
const isIPadOS = navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1;
const isApple = isIOS || isIPadOS;
const isMobile = /iPhone|iPad|iPod|Android/.test(navigator.userAgent);

// Parse the video URL from the query string
function parseVideoUrl() {
    const query = window.location.search.startsWith('?') ? window.location.search.slice(1) : window.location.search;
    if (!query) return '';
    const decoded = decodeURIComponent(query);
    // Wenn kein Protokoll vorhanden ist, https:// voranstellen
    return decoded.startsWith('http') ? decoded : ('https://' + decoded);
}

// Extract filename without extension for cookie name and title
function extractName(url) {
    try {
        const path = new URL(url).pathname;
        const parts = path.split('/').filter(Boolean);
        if (parts.length === 0) return '';
        const file = parts[parts.length - 1];
        return file.replace(/\.[^.]+$/, '');
    } catch (e) {
        return '';
    }
}

// Cookie Management
function setCookie(name, value, days) {
    const d = new Date();
    d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
    document.cookie = name + '=' + value + ';expires=' + d.toUTCString() + ';path=/;SameSite=Lax';
}

function getCookie(name) {
    const nameEQ = name + '=';
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length);
    }
    return null;
}

function deleteCookie(name) {
    document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;';
}

// Progress Management using localStorage with cookie fallback
function setProgress(name, value, days = 30) {
    // Try localStorage
    try {
        localStorage.setItem(name, value);
    } catch (e) {
        // ignore
    }
    setCookie(name, value, days);
}

function getProgress(name) {
    let val = null;
    try {
        val = localStorage.getItem(name);
    } catch (e) {
        // ignore
    }
    if (val === null || val === undefined) {
        val = getCookie(name);
    }
    return val;
}

function deleteProgress(name) {
    try {
        localStorage.removeItem(name);
    } catch (e) {
        // ignore
    }
    deleteCookie(name);
}

// Setup Video
function setupVideo() {
    const url = parseVideoUrl();
    if (!url) {
        console.error('Kein Videolink gefunden. Der Player wird abgebrochen.');
        return;
    }
    const name = extractName(url);
    // Set the document title
    if (name) {
        document.title = 'FilmFrei24 - ' + name;
    }
    // Lade das Video direkt ohne zusätzliche Fragment‑Parameter. Einige Hosting‑Provider
    // reagieren empfindlich auf URL‑Fragmente wie „#t=0.1“ und liefern ansonsten
    // eine Fehlermeldung zurück. Deshalb wird hier der exakt übergebene Link
    // verwendet, sodass auch externe Filme von filedn.eu oder anderen Anbietern
    // problemlos gestreamt werden können.
    video.src = url;
    // Set cookie name globally
    window.cookieName = 'vp_' + name.replace(/[^a-zA-Z0-9]/g, '_');
    console.log('Video geladen', { url });

    // Initiale Anzeige: Play-Icon zeigen und Pause-Icon ausblenden
    if (playIcon && pauseIcon) {
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
    }
}

// Resume with Dialog
function checkResume() {
    // Prüfe, ob ein zuvor gespeicherter Fortschritt existiert und über 5 Sekunden liegt.
    const savedTime = getProgress(window.cookieName);
    const savedTimeFloat = savedTime ? parseFloat(savedTime) : 0;
    if (savedTime && savedTimeFloat > 5) {
        // Zeige das Fortsetzen‑Dialog nur, wenn das Video geladen ist und der gespeicherte Zeitpunkt nicht am Ende liegt
        if (video.duration > 0 && savedTimeFloat < (video.duration - 5)) {
            // Pausiere das Video und zeige den Fortsetzen‑Dialog
            video.pause();
            resumeOverlay.classList.add('show');

            // Wenn der Nutzer auf „Fortsetzen“ klickt, springe direkt zur gespeicherten Position
            resumeBtn.onclick = () => {
                resumeOverlay.classList.remove('show');
                video.currentTime = Math.max(0, Math.min(savedTimeFloat, video.duration));
                video.play();
            };
            // „Neu starten“ setzt den Fortschritt zurück
            restartBtn.onclick = () => {
                resumeOverlay.classList.remove('show');
                deleteProgress(window.cookieName);
                video.currentTime = 0;
                video.play();
            };

            // Automatisches Fortsetzen nach kurzer Wartezeit, wenn der Nutzer nichts auswählt
            setTimeout(() => {
                if (resumeOverlay.classList.contains('show')) {
                    resumeOverlay.classList.remove('show');
                    video.currentTime = Math.max(0, Math.min(savedTimeFloat, video.duration));
                    video.play();
                }
            }, 4000);
        } else {
            deleteProgress(window.cookieName);
        }
    }
}

// Play/Pause Toggle
function togglePlay() {
    if (video.paused) {
        video.play();
    } else {
        video.pause();
    }
}

// Progress Saving
function startProgressSaving() {
    // Speichere den Videofortschritt alle 1 Sekunde, solange das Video läuft und nicht am Ende ist.
    if (progressInterval) clearInterval(progressInterval);
    progressInterval = setInterval(() => {
        if (!video.paused && video.currentTime > 0 && video.duration > 0) {
            // Speichere nur, wenn noch mehr als 5 Sekunden vom Video verbleiben
            if (video.currentTime < (video.duration - 5)) {
                setProgress(window.cookieName, video.currentTime, 30);
            } else {
                // Entferne den Cookie kurz vor dem Ende
                deleteProgress(window.cookieName);
            }
        }
    }, 1000);
}

// Controls Visibility
function showControls() {
    controls.classList.add('show');
    clearTimeout(controlsTimer);
    if (!video.paused) {
        controlsTimer = setTimeout(() => {
            controls.classList.remove('show');
        }, 3000);
    }
}

// Progress Bar Updates
function updateProgress() {
    if (video.duration && !isDragging) {
        const percent = (video.currentTime / video.duration) * 100;
        progressFill.style.width = percent + '%';
        const current = formatTime(video.currentTime);
        const total = formatTime(video.duration);
        time.textContent = `${current} / ${total}`;
    }
}

function updateBuffered() {
    if (video.buffered.length > 0 && video.duration > 0) {
        const bufferedEnd = video.buffered.end(video.buffered.length - 1);
        const percent = (bufferedEnd / video.duration) * 100;
        progressBuffer.style.width = percent + '%';
    }
}

function formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return '0:00';
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = Math.floor(seconds % 60);
    if (h > 0) {
        return `${h}:${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
    }
    return `${m}:${s < 10 ? '0' : ''}${s}`;
}

// Seek Function
function seek(e) {
    if (video.duration > 0) {
        const rect = progress.getBoundingClientRect();
        const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
        video.currentTime = percent * video.duration;
    }
}

// Volume Controls
function updateVolume(e) {
    const rect = volumeSlider.getBoundingClientRect();
    const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
    video.volume = percent;
    volumeFill.style.width = (percent * 100) + '%';
    if (video.volume === 0) {
        video.muted = true;
        volumeIcon.style.display = 'none';
        muteIcon.style.display = 'block';
    } else {
        video.muted = false;
        volumeIcon.style.display = 'block';
        muteIcon.style.display = 'none';
    }
}

function toggleMute() {
    video.muted = !video.muted;
    if (video.muted) {
        volumeIcon.style.display = 'none';
        muteIcon.style.display = 'block';
    } else {
        volumeIcon.style.display = 'block';
        muteIcon.style.display = 'none';
    }
}

// Fullscreen - iOS optimiert
function toggleFullscreen() {
    if (!isFullscreen) {
        enterFullscreen();
    } else {
        exitFullscreen();
    }
}

function enterFullscreen() {
    if (isApple) {
        try {
            if (video.webkitEnterFullscreen) {
                video.webkitEnterFullscreen();
                return;
            }
        } catch (error) {}
    }
    const elem = player;
    try {
        if (elem.requestFullscreen) {
            elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
        } else if (elem.webkitRequestFullScreen) {
            elem.webkitRequestFullScreen();
        } else if (elem.mozRequestFullScreen) {
            elem.mozRequestFullScreen();
        } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen();
        } else {
            player.classList.add('fullscreen-active');
            document.body.classList.add('fullscreen-active');
            isFullscreen = true;
            updateFullscreenButton(true);
        }
    } catch (error) {
        player.classList.add('fullscreen-active');
        document.body.classList.add('fullscreen-active');
        isFullscreen = true;
        updateFullscreenButton(true);
    }
}

function exitFullscreen() {
    if (isApple) {
        try {
            if (video.webkitExitFullscreen) {
                video.webkitExitFullscreen();
                return;
            }
        } catch (error) {}
    }
    try {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.webkitCancelFullScreen) {
            document.webkitCancelFullScreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        } else {
            player.classList.remove('fullscreen-active');
            document.body.classList.remove('fullscreen-active');
            isFullscreen = false;
            updateFullscreenButton(false);
        }
    } catch (error) {
        player.classList.remove('fullscreen-active');
        document.body.classList.remove('fullscreen-active');
        isFullscreen = false;
        updateFullscreenButton(false);
    }
}

function updateFullscreenButton(fullscreenState) {
    if (fullscreenState) {
        enterFS.style.display = 'none';
        exitFS.style.display = 'block';
    } else {
        enterFS.style.display = 'block';
        exitFS.style.display = 'none';
    }
}

// Setup menus for audio and subtitles

// Reset at end
function resetOnEnd() {
    deleteProgress(window.cookieName);
    clearInterval(progressInterval);
    video.currentTime = 0;
    hasAutoResumed = false;
    playIcon.style.display = 'block';
    pauseIcon.style.display = 'none';
}

// Event Listeners
playPause.addEventListener('click', togglePlay);
tapArea.addEventListener('click', function(e) {
    const currentTime = Date.now();
    const tapInterval = currentTime - lastTapTime;
    if (tapInterval < 300 && tapInterval > 0) {
        e.preventDefault();
        const rect = tapArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        if (video.duration > 0) {
            if (x < rect.width / 2) {
                video.currentTime = Math.max(0, video.currentTime - 10);
            } else {
                video.currentTime = Math.min(video.duration, video.currentTime + 10);
            }
        }
    } else {
        togglePlay();
    }
    lastTapTime = currentTime;
});
progress.addEventListener('click', seek);
mute.addEventListener('click', toggleMute);
volumeSlider.addEventListener('click', updateVolume);
fullscreenBtn.addEventListener('click', toggleFullscreen);
// On metadata loaded, prepare audio track selection if multiple tracks exist
video.addEventListener('loadedmetadata', () => {
    // Kein Setup für Audio- und Untertitelmenüs erforderlich
});

// Zusätzlich nach loadeddata prüfen, da einige Browser Audiospuren erst dann bereitstellen
video.addEventListener('loadeddata', () => {
    // Keine erneute Prüfung für Audio- und Untertitelmenüs nötig
});
video.addEventListener('canplay', () => {
    loader.classList.add('hide');
    if (!hasAutoResumed && video.duration > 0) {
        hasAutoResumed = true;
        setTimeout(() => checkResume(), 500);
    }
});
video.addEventListener('playing', () => {
    loader.classList.add('hide');
    playIcon.style.display = 'none';
    pauseIcon.style.display = 'block';
    startProgressSaving();
    showControls();
});
video.addEventListener('pause', () => {
    playIcon.style.display = 'block';
    pauseIcon.style.display = 'none';
    showControls();
});
video.addEventListener('timeupdate', updateProgress);
video.addEventListener('progress', updateBuffered);
video.addEventListener('ended', resetOnEnd);
player.addEventListener('mousemove', showControls);
player.addEventListener('touchstart', showControls);
document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
document.addEventListener('mozfullscreenchange', handleFullscreenChange);
document.addEventListener('MSFullscreenChange', handleFullscreenChange);
if (isApple) {
    video.addEventListener('webkitbeginfullscreen', () => {
        isFullscreen = true;
        updateFullscreenButton(true);
    });
    video.addEventListener('webkitendfullscreen', () => {
        isFullscreen = false;
        updateFullscreenButton(false);
    });
}
function handleFullscreenChange() {
    const isInFullscreen = !!(document.fullscreenElement ||
                             document.webkitFullscreenElement ||
                             document.mozFullScreenElement ||
                             document.msFullscreenElement);
    isFullscreen = isInFullscreen;
    updateFullscreenButton(isInFullscreen);
    if (!isInFullscreen) {
        player.classList.remove('fullscreen-active');
        document.body.classList.remove('fullscreen-active');
    }
}
// Keyboard controls
document.addEventListener('keydown', e => {
    switch(e.key) {
        case ' ':
        case 'k':
            e.preventDefault();
            togglePlay();
            break;
        case 'f':
            toggleFullscreen();
            break;
        case 'm':
            toggleMute();
            break;
        case 'ArrowLeft':
            video.currentTime = Math.max(0, video.currentTime - 10);
            break;
        case 'ArrowRight':
            video.currentTime = Math.min(video.duration, video.currentTime + 10);
            break;
    }
});

// Big Play Button logic
const bigPlayBtn = document.getElementById('bigPlayBtn');
if (bigPlayBtn) {
    bigPlayBtn.addEventListener('click', () => {
        // Beim ersten Klick: Play Button ausblenden, Loader zeigen und Video starten
        bigPlayBtn.classList.add('hide');
        loader.classList.remove('hide');
        const playPromise = video.play();
        if (playPromise && typeof playPromise.then === 'function') {
            playPromise.catch(() => {
                // Falls die Wiedergabe blockiert wird, bleibt der Button verborgen. 
                // Der Nutzer kann über die regulären Steuerelemente starten.
            });
        }
    });
    // Wenn das Video zu spielen beginnt, verstecke den Button (zur Sicherheit)
    video.addEventListener('playing', () => {
        bigPlayBtn.classList.add('hide');
    });
}

// Removed audio and subtitle dropdown logic as there are no menus to toggle
// Initialize
setupVideo();
showControls();
console.log('FilmFrei24 HTML Player initialisiert');
    </script>
</body>
</html>